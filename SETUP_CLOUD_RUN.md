# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Google Cloud Run

## –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ö–∞—Ä—Ç–æ—á–∫–∞ –º–æ–¥–µ–ª–∏
‚úÖ **–ö–∞—Ä—Ç–æ—á–∫–∞ –º–æ–¥–µ–ª–∏ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**

–ö–æ–≥–¥–∞ –≤—ã –ø–∏—à–µ—Ç–µ –∏–º—è –º–æ–¥–µ–ª–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–º–µ–ª–∏—Å–∞"), –±–æ—Ç:
1. –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —ç—Ç–æ –∫–∞–∫ –∫–æ–º–∞–Ω–¥—É `SEARCH_MODEL`
2. –ò—â–µ—Ç –º–æ–¥–µ–ª—å –≤ –±–∞–∑–µ Notion (–ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ –∞–ª–∏–∞—Å—É)
3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–∞—Ä—Ç–æ—á–∫—É –º–æ–¥–µ–ª–∏ —Å –∫–Ω–æ–ø–∫–∞–º–∏:
   - üì¶ –ó–∞–∫–∞–∑—ã
   - üìÖ –°—ä—ë–º–∫–∞
   - üìÅ –§–∞–π–ª—ã

–ü—Ä–∏–º–µ—Ä:
```
–í—ã ‚Üí –º–µ–ª–∏—Å–∞
–ë–æ—Ç ‚Üí üìå –ú–µ–ª–∏—Å–∞
      üì¶ –ó–∞–∫–∞–∑—ã: open 2
      üìÖ –°—ä—ë–º–∫–∞: 15.02 (planned)
      üìÅ –§–∞–π–ª—ã (—Ñ–µ–≤): 90/200 (45%)

      –ß—Ç–æ –¥–µ–ª–∞–µ–º?
      [üì¶ –ó–∞–∫–∞–∑—ã] [üìÖ –°—ä—ë–º–∫–∞] [üìÅ –§–∞–π–ª—ã]
      [‚ôªÔ∏è –°–±—Ä–æ—Å]
```

### 2. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Google Cloud Run

**–ü—Ä–æ–±–ª–µ–º–∞:** –í workflow —Ñ–∞–π–ª–µ –æ—Ç—Å—É—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `CRM_TOPIC_THREAD_ID` –∏ –±—ã–ª–∏ –ª–∏—à–Ω–∏–µ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `CRM_TOPIC_THREAD_ID`
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è `FILES_PER_MONTH`
- ‚úÖ –£–¥–∞–ª–µ–Ω—ã –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ `FILES_TARGET_WORK` –∏ `FILES_TARGET_NEW`

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –≤ GitHub

### Secrets (Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Repository secrets)

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ **secrets**:
```
TELEGRAM_BOT_TOKEN=–≤–∞—à_—Ç–æ–∫–µ–Ω_–±–æ—Ç–∞
TELEGRAM_WEBHOOK_SECRET=—Å–ª—É—á–∞–π–Ω–∞—è_—Å—Ç—Ä–æ–∫–∞_–¥–ª—è_–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
NOTION_TOKEN=secret_–≤–∞—à_notion_integration_token
DB_MODELS=uuid_–±–∞–∑—ã_–º–æ–¥–µ–ª–µ–π
DB_ORDERS=uuid_–±–∞–∑—ã_–∑–∞–∫–∞–∑–æ–≤
DB_PLANNER=uuid_–±–∞–∑—ã_–ø–ª–∞–Ω–µ—Ä–∞
DB_ACCOUNTING=uuid_–±–∞–∑—ã_—É—á–µ—Ç–∞
```

### Variables (Settings ‚Üí Secrets and variables ‚Üí Actions ‚Üí Variables)

–î–æ–±–∞–≤—å—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ **variables**:
```
TIMEZONE=Europe/Brussels
ALLOWED_EDITORS=123456789,987654321
CRM_TOPIC_THREAD_ID=12345
FILES_PER_MONTH=200
```

#### –í–∞–∂–Ω–æ –ø—Ä–æ ALLOWED_EDITORS:
- –§–æ—Ä–º–∞—Ç: —Å–ø–∏—Å–æ–∫ Telegram user ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
- –ü—Ä–∏–º–µ—Ä: `123456789,987654321`
- **–ù–ï –°–¢–ê–í–¨–¢–ï –ø—Ä–æ–±–µ–ª—ã –ø–æ—Å–ª–µ –∑–∞–ø—è—Ç–æ–π**
- –ü—Ä–∞–≤–∏–ª—å–Ω–æ: `123,456,789`
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ: `123, 456, 789`

#### –ö–∞–∫ —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram user ID:
1. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É [@userinfobot](https://t.me/userinfobot)
2. –û–Ω –≤–µ—Ä–Ω–µ—Ç –≤–∞—à ID (–Ω–∞–ø—Ä–∏–º–µ—Ä: `123456789`)

#### –í–∞–∂–Ω–æ –ø—Ä–æ CRM_TOPIC_THREAD_ID:
- –≠—Ç–æ ID —Ç–æ–ø–∏–∫–∞ (—Ç–µ–º—ã) –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ Telegram
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
- –î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è ID —Ç–æ–ø–∏–∫–∞:
  1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–æ–ø–∏–∫ –≤ —Å—É–ø–µ—Ä–≥—Ä—É–ø–ø–µ
  2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ
  3. ID —Ç–æ–ø–∏–∫–∞ –±—É–¥–µ—Ç –≤ URL –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ `/`

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GitHub Secrets –≤ Google Cloud Project

–¢–∞–∫–∂–µ –≤–∞–º –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ secrets –¥–ª—è Google Cloud:

```
GCP_PROJECT=your-gcp-project-id
GCP_REGION=europe-west1
GCP_WIF_PROVIDER=projects/123/locations/global/workloadIdentityPools/...
GCP_SA_EMAIL=github-actions@your-project.iam.gserviceaccount.com
CLOUD_RUN_SERVICE=orochimary-bot
```

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

–ü–æ—Å–ª–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ workflow –≤—Ä—É—á–Ω—É—é: Actions ‚Üí Deploy TG Bot (Cloud Run) ‚Üí Run workflow
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –¥–µ–ø–ª–æ—è –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
3. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –¥–µ–ø–ª–æ—è –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ Cloud Run:
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Google Cloud Console
   - –û—Ç–∫—Ä–æ–π—Ç–µ Cloud Run ‚Üí –≤–∞—à —Å–µ—Ä–≤–∏—Å
   - –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ LOGS
   - –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –Ω–µ—Ç –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

## –ü—Ä–æ "—Ä–∞–∑–Ω–µ—Å–µ–Ω–∏–µ –≤ —Ä–∞–∑–Ω—ã–µ –ø–æ–ª—è"

–í Google Cloud Run Console –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è **–≤—Å–µ–≥–¥–∞** –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª—è—Ö - —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ:
```
TELEGRAM_BOT_TOKEN: [–∑–Ω–∞—á–µ–Ω–∏–µ]
ALLOWED_EDITORS:    [–∑–Ω–∞—á–µ–Ω–∏–µ]
CRM_TOPIC_THREAD_ID: [–∑–Ω–∞—á–µ–Ω–∏–µ]
...
```

–ï—Å–ª–∏ –≤—ã –≤–∏–¥–∏—Ç–µ, —á—Ç–æ `ALLOWED_EDITORS` —Å–æ–¥–µ—Ä–∂–∏—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ ID —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é (–Ω–∞–ø—Ä–∏–º–µ—Ä `123,456`), —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ! –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç —ç—Ç–æ –∑–Ω–∞—á–µ–Ω–∏–µ.

## –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç ALLOWED_EDITORS –≤ –∫–æ–¥–µ

–ö–æ–¥ –≤ `app/config.py` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–∞—Ä—Å–∏—Ç —Å–ø–∏—Å–æ–∫ ID:
```python
def _parse_user_ids(value: str) -> set[int]:
    """Parse comma-separated user IDs from env variable."""
    result: set[int] = set()
    for item in value.split(","):
        item = item.strip()
        if item:
            result.add(int(item))
    return result
```

–î–∞–∂–µ –µ—Å–ª–∏ –≤—ã —Å–ª—É—á–∞–π–Ω–æ –ø–æ—Å—Ç–∞–≤–∏—Ç–µ –ø—Ä–æ–±–µ–ª—ã (`123, 456, 789`), –∫–æ–¥ –∏—Ö –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç.
