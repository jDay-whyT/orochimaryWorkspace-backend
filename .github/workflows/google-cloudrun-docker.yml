name: Deploy TG Bot (Cloud Run)
run-name: Deploy ${{ github.ref_name }} â€” ${{ github.sha }}

on:
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Prepare deployment variables
        id: vars
        run: |
          set -euo pipefail

          PROJECT_RAW="${{ secrets.GCP_PROJECT }}"
          REGION_RAW="${{ secrets.GCP_REGION }}"
          SERVICE="${{ secrets.CLOUD_RUN_SERVICE }}"
          AR_REPO="orochimary"
          IMAGE="orochimary-bot"

          PROJECT_ID_LC="$(echo "$PROJECT_RAW" | tr '[:upper:]' '[:lower:]')"
          REGION_LC="$(echo "$REGION_RAW" | tr '[:upper:]' '[:lower:]')"
          AR_REPO_LC="$(echo "$AR_REPO" | tr '[:upper:]' '[:lower:]')"
          IMAGE_LC="$(echo "$IMAGE" | tr '[:upper:]' '[:lower:]')"

          if [[ ! "$PROJECT_ID_LC" =~ ^[a-z0-9-]+$ ]]; then
            echo "::error::GCP_PROJECT must be a valid project-id (lowercase letters, digits, hyphens). Received: '$PROJECT_RAW'"
            exit 1
          fi

          if [[ ! "$REGION_LC" =~ ^[a-z0-9-]+$ ]]; then
            echo "::error::GCP_REGION must be lowercase letters, digits, hyphens. Received: '$REGION_RAW'"
            exit 1
          fi

          if [[ ! "$AR_REPO_LC" =~ ^[a-z0-9-]+$ ]]; then
            echo "::error::Artifact Registry repo must be lowercase letters, digits, hyphens. Received: '$AR_REPO'"
            exit 1
          fi

          if [[ ! "$IMAGE_LC" =~ ^[a-z0-9-]+$ ]]; then
            echo "::error::Image name must be lowercase letters, digits, hyphens. Received: '$IMAGE'"
            exit 1
          fi

          IMAGE_URI="${REGION_LC}-docker.pkg.dev/${PROJECT_ID_LC}/${AR_REPO_LC}/${IMAGE_LC}:${{ github.sha }}"

          echo "Computed REGION=${REGION_LC}"
          echo "Computed PROJECT_ID_LC=${PROJECT_ID_LC}"
          echo "Computed AR_REPO=${AR_REPO_LC}"
          echo "Computed IMAGE=${IMAGE_LC}"
          echo "Computed SERVICE=${SERVICE}"
          echo "Computed IMAGE_URI=${IMAGE_URI}"

          {
            echo "region=${REGION_LC}"
            echo "project_id=${PROJECT_ID_LC}"
            echo "ar_repo=${AR_REPO_LC}"
            echo "image=${IMAGE_LC}"
            echo "service=${SERVICE}"
            echo "image_uri=${IMAGE_URI}"
          } >> "$GITHUB_OUTPUT"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker "${{ steps.vars.outputs.region }}-docker.pkg.dev" --quiet

      - name: Build and push image
        run: |
          docker build -t "${{ steps.vars.outputs.image_uri }}" .
          docker push "${{ steps.vars.outputs.image_uri }}"

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ steps.vars.outputs.service }}
          region: ${{ steps.vars.outputs.region }}
          image: ${{ steps.vars.outputs.image_uri }}
          env_vars: |-
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            NOTION_TOKEN=${{ secrets.NOTION_TOKEN }}
            NOTION_ORDERS_DB_ID=${{ secrets.NOTION_ORDERS_DB_ID }}
            NOTION_MODELS_DB_ID=${{ secrets.NOTION_MODELS_DB_ID }}
